{% extends "base.html" %}

{% block title %}Dashboard Siswa{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h3>Formulir Pendaftaran Siswa</h3>
                {% if not form %}
                    <form method="POST" action="{{ url_for('main.submit_form') }}" enctype="multipart/form-data" id="admission-form">
                        {{ admission_form.hidden_tag() }}
                        
                        <div class="mb-3">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" value="{{ current_user.name }}" readonly>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="gender" class="form-label">Jenis Kelamin</label>
                                    {{ admission_form.gender(class="form-control") }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="religion" class="form-label">Agama</label>
                                    {{ admission_form.religion(class="form-control") }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="birth_date" class="form-label">Tanggal Lahir</label>
                            {{ admission_form.birth_date(class="form-control") }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="address" class="form-label">Alamat</label>
                            {{ admission_form.address(class="form-control") }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="phone" class="form-label">Nomor Telepon</label>
                            {{ admission_form.phone(class="form-control") }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="previous_school" class="form-label">Sekolah Asal</label>
                            {{ admission_form.previous_school(class="form-control") }}
                        </div>
                        
                        <h4 class="mt-4">Dokumen Wajib</h4>
                        
                        <div class="mb-3">
                            <label for="graduation_certificate" class="form-label">Ijazah/SKL</label>
                            {{ admission_form.graduation_certificate(class="form-control") }}
                            <small class="text-muted">Upload PDF atau gambar (jpg, png)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="birth_certificate" class="form-label">Akta Kelahiran</label>
                            {{ admission_form.birth_certificate(class="form-control") }}
                            <small class="text-muted">Upload PDF atau gambar (jpg, png)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="family_card" class="form-label">Kartu Keluarga</label>
                            {{ admission_form.family_card(class="form-control") }}
                            <small class="text-muted">Upload PDF atau gambar (jpg, png)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="report_card" class="form-label">Rapor</label>
                            {{ admission_form.report_card(class="form-control") }}
                            <small class="text-muted">Upload PDF atau gambar (jpg, png)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="photo" class="form-label">Pas Foto</label>
                            {{ admission_form.photo(class="form-control") }}
                            <small class="text-muted">Upload gambar saja (jpg, png)</small>
                        </div>

                        <h4 class="mt-4">Jalur Pendaftaran (Opsional)</h4>
                        <div class="mb-3">
                            <label class="form-label">Pilih Jalur</label>
                            {{ admission_form.registration_track(class="form-control") }}
                            <small class="text-muted">Pilih jalur jika Anda memenuhi syarat</small>
                        </div>

                        <div id="trackDocs" style="display: none;">
                            <div id="achievementDocs" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Sertifikat Prestasi</label>
                                    {{ admission_form.achievement_docs(class="form-control") }}
                                    <small class="text-muted">Upload sertifikat prestasi akademik/non-akademik</small>
                                </div>
                            </div>
                            
                            <div id="affirmationDocs" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Dokumen Afirmasi</label>
                                    {{ admission_form.affirmation_docs(class="form-control") }}
                                    <small class="text-muted">Upload dokumen pendukung kelayakan</small>
                                </div>
                            </div>
                            
                            <div id="domicileDocs" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Surat Keterangan Domisili</label>
                                    {{ admission_form.domicile_docs(class="form-control") }}
                                    <small class="text-muted">Upload surat keterangan domisili dari RT/RW dan kelurahan</small>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Kirim Pendaftaran</button>
                    </form>
                {% else %}
                    <div class="submitted-data">
                        <div class="alert alert-info mb-4">
                            Status pendaftaran Anda: 
                            <strong>
                                {% if form.status == 'pending' %}
                                    Menunggu Verifikasi
                                {% elif form.status == 'accepted' %}
                                    Diterima
                                {% elif form.status == 'rejected' %}
                                    Ditolak
                                {% endif %}
                            </strong>
                        </div>

                        <h4 class="mb-4">Data Pendaftaran</h4>
                        
                        <!-- Personal Information -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Personal Information</h5>
                                <button type="button" class="btn btn-primary btn-sm" id="editPersonalInfo">
                                    <i class="bi bi-pencil-fill me-1"></i>Edit
                                </button>
                            </div>
                            <div class="card-body">
                                <form id="personalInfoForm" class="needs-validation" novalidate>
                                    <div class="row g-3">
                                        <!-- Name field (readonly) -->
                                        <div class="col-md-6">
                                            <label class="form-label">Name</label>
                                            <input type="text" class="form-control" value="{{ current_user.name }}" readonly>
                                        </div>
                                        
                                        <!-- Gender field -->
                                        <div class="col-md-6">
                                            <label class="form-label">Gender</label>
                                            <select name="gender" class="form-control profile-field" disabled>
                                                <option value="Laki-laki" {% if form.gender == 'Laki-laki' %}selected{% endif %}>Laki-laki</option>
                                                <option value="Perempuan" {% if form.gender == 'Perempuan' %}selected{% endif %}>Perempuan</option>
                                            </select>
                                            <div class="update-status"></div>
                                        </div>
                                        
                                        <!-- Birth Date field -->
                                        <div class="col-md-6">
                                            <label class="form-label">Birth Date</label>
                                            <input type="date" name="birth_date" class="form-control profile-field" 
                                                   value="{{ form.parsed_form_data.get('birth_date', '') }}" disabled>
                                            <div class="update-status"></div>
                                        </div>
                                        
                                        <!-- Religion field -->
                                        <div class="col-md-6">
                                            <label class="form-label">Religion</label>
                                            <select name="religion" class="form-control profile-field" disabled>
                                                {% for religion in ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'] %}
                                                    <option value="{{ religion }}" {% if form.religion == religion %}selected{% endif %}>
                                                        {{ religion }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            <div class="update-status"></div>
                                        </div>
                                        
                                        <!-- Address field -->
                                        <div class="col-12">
                                            <label class="form-label">Address</label>
                                            <textarea name="address" class="form-control profile-field" rows="2" disabled>{{ form.parsed_form_data.get('address', '') }}</textarea>
                                            <div class="update-status"></div>
                                        </div>
                                        
                                        <!-- Phone field -->
                                        <div class="col-md-6">
                                            <label class="form-label">Phone</label>
                                            <input type="tel" name="phone" class="form-control profile-field" 
                                                   value="{{ form.parsed_form_data.get('phone', '') }}" disabled>
                                            <div class="update-status"></div>
                                        </div>
                                        
                                        <!-- Previous School field -->
                                        <div class="col-md-6">
                                            <label class="form-label">Previous School</label>
                                            <input type="text" name="previous_school" class="form-control profile-field" 
                                                   value="{{ form.parsed_form_data.get('previous_school', '') }}" disabled>
                                            <div class="update-status"></div>
                                        </div>

                                        <!-- Save/Cancel buttons (initially hidden) -->
                                        <div class="col-12 mt-3 d-none" id="personalInfoButtons">
                                            <button type="button" class="btn btn-primary" id="savePersonalInfo">
                                                <i class="bi bi-check-lg me-1"></i>Save Changes
                                            </button>
                                            <button type="button" class="btn btn-secondary" id="cancelPersonalInfo">
                                                <i class="bi bi-x-lg me-1"></i>Cancel
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>


                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Informasi Pribadi</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted">Nama Lengkap</label>
                                        <p class="mb-0">{{ current_user.name }}</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted">Jenis Kelamin</label>
                                        <p class="mb-0">{{ form.gender }}</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted">Agama</label>
                                        <p class="mb-0">{{ form.religion }}</p>
                                    </div>
                                    {% if form.parsed_form_data %}
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted">Tanggal Lahir</label>
                                        <p class="mb-0">{{ form.parsed_form_data.get('birth_date', '-') }}</p>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="text-muted">Alamat</label>
                                        <p class="mb-0">{{ form.parsed_form_data.get('address', '-') }}</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted">Nomor Telepon</label>
                                        <p class="mb-0">{{ form.parsed_form_data.get('phone', '-') }}</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted">Sekolah Asal</label>
                                        <p class="mb-0">{{ form.parsed_form_data.get('previous_school', '-') }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Document Management Card -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-file-earmark-text text-primary me-2"></i>Dokumen
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Add hidden form ID -->
                                <input type="hidden" id="formId" value="{{ form.id if form else '' }}">
                                
                                <div class="document-grid">
                                    {% set documents = [
                                        ('graduation_certificate', 'Ijazah/SKL', form.graduation_certificate_data if form else None, 'bi-file-earmark-text'),
                                        ('birth_certificate', 'Akta Kelahiran', form.birth_certificate_data if form else None, 'bi-file-earmark-person'),
                                        ('family_card', 'Kartu Keluarga', form.family_card_data if form else None, 'bi-file-earmark-spreadsheet'),
                                        ('report_card', 'Rapor', form.report_card_data if form else None, 'bi-file-earmark-ruled'),
                                        ('photo', 'Pas Foto', form.photo_data if form else None, 'bi-person-square')
                                    ] %}
                                    
                                    {% for doc_id, doc_name, doc_data, icon in documents %}
                                    <div class="document-item card border mb-3">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="document-icon me-3">
                                                    <i class="bi {{ icon }} fs-4 text-{{ 'success' if doc_data else 'secondary' }}"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">{{ doc_name }}</h6>
                                                    <small class="text-muted doc-status" data-doc-type="{{ doc_id }}">
                                                        {% if doc_data %}
                                                            <i class="bi bi-check-circle-fill text-success me-1"></i>
                                                            {{ form[doc_id + '_filename'] }}
                                                        {% else %}
                                                            <i class="bi bi-exclamation-circle-fill text-warning me-1"></i>
                                                            Belum diunggah
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <div class="document-actions">
                                                {% if doc_data %}
                                                <div class="btn-group w-100">                                                    <button type="button" class="btn btn-outline-primary btn-sm flex-grow-1 view-doc-btn" 
                                                            data-doc-type="{{ doc_id }}">
                                                        <i class="bi bi-eye me-1"></i>Lihat
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm upload-doc-btn"
                                                            data-doc-type="{{ doc_id }}">
                                                        <i class="bi bi-arrow-repeat me-1"></i>Update
                                                    </button>
                                                </div>
                                                {% else %}
                                                <button type="button" class="btn btn-primary btn-sm w-100 upload-doc-btn"
                                                        data-doc-type="{{ doc_id }}">
                                                    <i class="bi bi-upload me-1"></i>Upload
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <input type="file" class="d-none document-input" 
                                               data-doc-type="{{ doc_id }}"
                                               accept=".pdf,.jpg,.jpeg,.png">
                                    </div>
                                    {% endfor %}
                                    
                                    {% if form and form.registration_track %}
                                    <!-- Track-specific Document -->
                                    <div class="document-item card border mb-3">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="document-icon me-3">
                                                    <i class="bi bi-file-earmark-check fs-4 text-{{ 'success' if form.track_document_data else 'secondary' }}"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">Dokumen {{ 
                                                        'Prestasi' if form.registration_track == 'achievement' 
                                                        else 'Afirmasi' if form.registration_track == 'affirmation'
                                                        else 'Zonasi' if form.registration_track == 'domicile'
                                                        else '' }}</h6>
                                                    <small class="text-muted doc-status" data-doc-type="track_document">
                                                        {% if form.track_document_data %}
                                                            <i class="bi bi-check-circle-fill text-success me-1"></i>
                                                            {{ form.track_document_filename }}
                                                        {% else %}
                                                            <i class="bi bi-exclamation-circle-fill text-warning me-1"></i>
                                                            Belum diunggah
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <div class="document-actions">
                                                {% if form.track_document_data %}
                                                <div class="btn-group w-100">
                                                    <button type="button" class="btn btn-outline-primary btn-sm flex-grow-1 view-doc-btn" 
                                                            data-doc-type="track_document" data-bs-toggle="modal" 
                                                            data-bs-target="#fileModal_track_document">
                                                        <i class="bi bi-eye me-1"></i>Lihat
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm upload-doc-btn"
                                                            data-doc-type="track_document">
                                                        <i class="bi bi-arrow-repeat me-1"></i>Update
                                                    </button>
                                                </div>
                                                {% else %}
                                                <button type="button" class="btn btn-primary btn-sm w-100 upload-doc-btn"
                                                        data-doc-type="track_document">
                                                    <i class="bi bi-upload me-1"></i>Upload
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <input type="file" class="d-none document-input" 
                                               data-doc-type="track_document"
                                               accept=".pdf,.jpg,.jpeg,.png">
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Registration Track -->
                        {% if form.registration_track %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Jalur Pendaftaran</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Jalur yang Dipilih:</strong><br>
                                    {% if form.registration_track == 'achievement' %}
                                        Jalur Prestasi
                                    {% elif form.registration_track == 'affirmation' %}
                                        Jalur Afirmasi
                                    {% elif form.registration_track == 'domicile' %}
                                        Jalur Domisili
                                    {% endif %}
                                </p>
                                
                                {% if form.achievement_docs_data or form.affirmation_docs_data or form.domicile_docs_data %}
                                    <p><i class="bi bi-check-circle-fill text-success"></i> Dokumen pendukung telah diupload</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Payment Section -->
                        {% if form.status == 'accepted' %}
            <!-- Payment Information Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-credit-card text-primary me-2"></i>Informasi Pembayaran
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Payment Status -->
                    <div class="payment-status-section mb-4">
                        <h6 class="text-muted mb-3">Status Pembayaran</h6>
                        <div class="d-flex align-items-center">
                            <div class="status-badge me-3">
                                <span class="badge bg-{{ 'success' if form.payment_status == 'verified' 
                                                       else 'warning' if form.payment_status == 'submitted'
                                                       else 'secondary' }} p-2">
                                    <i class="bi bi-{{ 'check-circle-fill' if form.payment_status == 'verified'
                                                     else 'hourglass-split' if form.payment_status == 'submitted'
                                                     else 'wallet' }} me-1"></i>
                                    {{ 'Terverifikasi' if form.payment_status == 'verified'
                                       else 'Menunggu Verifikasi' if form.payment_status == 'submitted'
                                       else 'Belum Dibayar' }}
                                </span>
                            </div>
                            {% if form.payment_date %}
                            <small class="text-muted">
                                <i class="bi bi-calendar me-1"></i>{{ form.payment_date.strftime('%d-%m-%Y %H:%M') }}
                            </small>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Payment Details -->
                    <div class="payment-details-section mb-4">
                        <h6 class="text-muted mb-3">Rincian Biaya</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Biaya Pendaftaran</span>
                                    <span>Rp7.000.000</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>SPP (1 Bulan)</span>
                                    <span>Rp500.000</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Total Pembayaran</strong>
                                    <strong class="text-primary">Rp7.500.000</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="payment-methods-section">
                        <h6 class="text-muted mb-3">Metode Pembayaran</h6>
                        <div class="row g-3">
                            <!-- Bank Transfer -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-bank me-2"></i>Transfer Bank
                                        </h6>
                                        <div class="bank-info">
                                            <div class="mb-2">
                                                <small class="text-muted d-block mb-1">Bank</small>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">Bank Mandiri</span>
                                                    <button class="btn btn-sm btn-link p-0 copy-button" 
                                                            data-clipboard-text="Bank Mandiri">
                                                        <i class="bi bi-clipboard"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted d-block mb-1">Nomor Rekening</small>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">1234567890</span>
                                                    <button class="btn btn-sm btn-link p-0 copy-button" 
                                                            data-clipboard-text="1234567890">
                                                        <i class="bi bi-clipboard"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block mb-1">Atas Nama</small>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">SMKN 1 BEKASI</span>
                                                    <button class="btn btn-sm btn-link p-0 copy-button" 
                                                            data-clipboard-text="SMKN 1 BEKASI">
                                                        <i class="bi bi-clipboard"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- QRIS -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h6 class="mb-3">
                                            <i class="bi bi-qr-code me-2"></i>QRIS
                                        </h6>
                                        <img src="{{ url_for('static', filename='img/qr-code.png') }}" 
                                             alt="QRIS Payment" class="img-fluid mb-3" 
                                             style="max-width: 150px;">
                                        <p class="small text-muted mb-0">
                                            Scan untuk pembayaran instan via QRIS<br>
                                            (OVO, GoPay, DANA, dll)
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if form.payment_status == 'unsubmitted' %}
                    <!-- Payment Proof Upload -->
                    <div class="payment-upload-section mt-4">
                        <h6 class="text-muted mb-3">Upload Bukti Pembayaran</h6>
                        <form method="POST" action="{{ url_for('main.submit_payment') }}" 
                              enctype="multipart/form-data">
                            {{ payment_form.hidden_tag() }}
                            <div class="mb-3">
                                {{ payment_form.payment_proof(class="form-control") }}
                                <small class="text-muted">Format yang didukung: JPG, PNG, PDF</small>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-cloud-upload me-2"></i>Kirim Bukti Pembayaran
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>    <div class="col-md-4">
        <!-- Required Documents Card -->
        {% if form %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Required Documents</h5>
                </div>
                <div class="card-body">
                    <div class="document-list">
                        {% set documents = [
                            ('graduation_certificate', 'Ijazah/SKL', form.graduation_certificate_data),
                            ('birth_certificate', 'Akta Kelahiran', form.birth_certificate_data),
                            ('family_card', 'Kartu Keluarga', form.family_card_data),
                            ('report_card', 'Rapor', form.report_card_data),
                            ('photo', 'Pas Foto', form.photo_data)
                        ] %}
                        
                        {% for doc_id, doc_name, doc_data in documents %}
                            <div class="document-item d-flex align-items-center justify-content-between mb-3 p-2 border rounded">
                                <div>
                                    <h6 class="mb-0">{{ doc_name }}</h6>
                                    <small class="text-{{ 'success' if doc_data else 'warning' }}">
                                        {% if doc_data %}
                                            <i class="bi bi-check-circle-fill"></i> Uploaded

                                            </button>
                                        {% else %}
                                            <i class="bi bi-exclamation-circle-fill"></i> Not uploaded
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Notifications Card -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bell text-primary me-2"></i>Notifikasi
                </h5>
                {% if notifications %}
                <span class="badge bg-primary rounded-pill">{{ notifications|length }}</span>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <div class="notifications-list">
                    {% if form %}
                        {% if form.status == 'pending' %}
                        <div class="notification-item d-flex p-3 border-bottom">
                            <div class="notification-icon bg-info me-3">
                                <i class="bi bi-hourglass-split"></i>
                            </div>
                            <div class="notification-content">
                                <h6 class="notification-title mb-1">Menunggu Verifikasi</h6>
                                <p class="notification-text text-muted small mb-1">Dokumen Anda sedang dalam proses verifikasi</p>
                                <small class="notification-time text-muted">
                                    <i class="bi bi-clock me-1"></i>{{ form.timestamp.strftime('%d-%m-%Y %H:%M') }}
                                </small>
                            </div>
                        </div>
                        {% endif %}

                        {% if form.status == 'accepted' %}
                        <div class="notification-item d-flex p-3 border-bottom">
                            <div class="notification-icon bg-success me-3">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <div class="notification-content">
                                <h6 class="notification-title mb-1">Pendaftaran Diterima</h6>
                                <p class="notification-text text-muted small mb-1">Selamat! Pendaftaran Anda telah diterima</p>
                                <small class="notification-time text-muted">
                                    <i class="bi bi-clock me-1"></i>{{ form.timestamp.strftime('%d-%m-%Y %H:%M') }}
                                </small>
                            </div>
                        </div>

                        {% if form.payment_status == 'unsubmitted' %}
                        <div class="notification-item d-flex p-3 border-bottom">
                            <div class="notification-icon bg-warning me-3">
                                <i class="bi bi-credit-card"></i>
                            </div>
                            <div class="notification-content">
                                <h6 class="notification-title mb-1">Pembayaran Diperlukan</h6>
                                <p class="notification-text text-muted small mb-1">Silakan melakukan pembayaran biaya pendaftaran</p>
                                <small class="notification-time text-muted">
                                    <i class="bi bi-clock me-1"></i>{{ form.timestamp.strftime('%d-%m-%Y %H:%M') }}
                                </small>
                            </div>
                        </div>
                        {% endif %}

                        {% if form.payment_status == 'submitted' %}
                        <div class="notification-item d-flex p-3 border-bottom">
                            <div class="notification-icon bg-info me-3">
                                <i class="bi bi-hourglass-split"></i>
                            </div>
                            <div class="notification-content">
                                <h6 class="notification-title mb-1">Verifikasi Pembayaran</h6>
                                <p class="notification-text text-muted small mb-1">Pembayaran Anda sedang diverifikasi</p>
                                <small class="notification-time text-muted">
                                    <i class="bi bi-clock me-1"></i>{{ form.payment_date.strftime('%d-%m-%Y %H:%M') }}
                                </small>
                            </div>
                        </div>
                        {% endif %}

                        {% if form.payment_status == 'verified' %}
                        <div class="notification-item d-flex p-3 border-bottom">
                            <div class="notification-icon bg-success me-3">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <div class="notification-content">
                                <h6 class="notification-title mb-1">Pembayaran Terverifikasi</h6>
                                <p class="notification-text text-muted small mb-1">Pembayaran Anda telah dikonfirmasi</p>
                                <small class="notification-time text-muted">
                                    <i class="bi bi-clock me-1"></i>{{ form.payment_date.strftime('%d-%m-%Y %H:%M') }}
                                </small>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% if form.status == 'rejected' %}
                        <div class="notification-item d-flex p-3 border-bottom">
                            <div class="notification-icon bg-danger me-3">
                                <i class="bi bi-x-circle-fill"></i>
                            </div>
                            <div class="notification-content">
                                <h6 class="notification-title mb-1">Pendaftaran Ditolak</h6>
                                <p class="notification-text text-muted small mb-1">Maaf, pendaftaran Anda tidak dapat diterima</p>
                                <small class="notification-time text-muted">
                                    <i class="bi bi-clock me-1"></i>{{ form.timestamp.strftime('%d-%m-%Y %H:%M') }}
                                </small>
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-bell-slash fs-4 mb-2 d-block"></i>
                            <p class="mb-0">Belum ada notifikasi</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Existing Status Card -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title fw-bold mb-4">Status Pendaftaran</h5>
                {% if form %}
                    <!-- Progress Bar -->
                    <div class="progress-tracker mb-4">
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated {{ 'bg-danger' if form.status == 'rejected' }}" 
                                 role="progressbar" 
                                 style="width: {{ form.progress_percentage }}%"
                                 aria-valuenow="{{ form.progress_percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <div class="text-end text-muted mt-1">
                            <small>{{ form.progress_percentage }}% selesai</small>
                        </div>
                    </div>

                    <!-- Status Steps -->
                    <div class="status-steps">
                        <div class="status-step {{ 'completed' if form.status != 'pending' }} {{ 'active' if form.status == 'pending' }}">
                            <div class="status-icon">
                                <i class="bi {{ 'bi-check-circle-fill' if form.status != 'pending' else 'bi-circle-fill' }}"></i>
                            </div>
                            <div class="status-content">
                                <h6 class="mb-1">Pendaftaran Terkirim</h6>
                                <p class="text-muted small mb-0">{{ form.timestamp.strftime('%d-%m-%Y %H:%M') }}</p>
                            </div>
                        </div>

                        <div class="status-step {{ 'completed' if form.status == 'accepted' }} {{ 'active' if form.status == 'pending' }} {{ 'rejected' if form.status == 'rejected' }}">
                            <div class="status-icon">
                                {% if form.status == 'accepted' %}
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                {% elif form.status == 'rejected' %}
                                    <i class="bi bi-x-circle-fill text-danger"></i>
                                {% else %}
                                    <i class="bi bi-clock-fill text-warning"></i>
                                {% endif %}
                            </div>
                            <div class="status-content">
                                <h6 class="mb-1">Verifikasi Berkas</h6>
                                <p class="text-muted small mb-0">
                                    {% if form.status == 'pending' %}
                                        Sedang diverifikasi
                                    {% elif form.status == 'accepted' %}
                                        Berkas diterima
                                    {% elif form.status == 'rejected' %}
                                        Berkas ditolak
                                    {% endif %}
                                </p>
                            </div>
                        </div>

                        {% if form.status == 'accepted' %}
                            <div class="status-step {{ 'completed' if form.payment_status in ['submitted', 'verified'] }} {{ 'active' if form.payment_status == 'unsubmitted' }}">
                                <div class="status-icon">
                                    {% if form.payment_status == 'verified' %}
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                    {% elif form.payment_status == 'submitted' %}
                                        <i class="bi bi-clock-fill text-warning"></i>
                                    {% else %}
                                        <i class="bi bi-circle"></i>
                                    {% endif %}
                                </div>
                                <div class="status-content">
                                    <h6 class="mb-1">Pembayaran</h6>
                                    <p class="text-muted small mb-0">
                                        {% if form.payment_status == 'unsubmitted' %}
                                            Menunggu pembayaran
                                        {% elif form.payment_status == 'submitted' %}
                                            Menunggu verifikasi
                                        {% elif form.payment_status == 'verified' %}
                                            Pembayaran terverifikasi
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            {% if form.payment_status == 'verified' %}
                                <div class="status-step completed">
                                    <div class="status-icon">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                    </div>
                                    <div class="status-content">
                                        <h6 class="mb-1">Pendaftaran Selesai</h6>
                                        <p class="text-muted small mb-0">Selamat! Anda telah diterima</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>

                    <!-- Current Status Alert -->
                    <div class="alert alert-{{ 'success' if form.status == 'accepted' else 'danger' if form.status == 'rejected' else 'info' }} mt-4">
                        <div class="d-flex align-items-center">
                            <i class="bi {{ 'bi-check-circle-fill' if form.status == 'accepted' else 'bi-x-circle-fill' if form.status == 'rejected' else 'bi-info-circle-fill' }} me-2"></i>
                            <div>
                                <strong>Status Saat Ini:</strong><br>
                                {% if form.status == 'pending' %}
                                    Menunggu Verifikasi
                                {% elif form.status == 'accepted' %}
                                    Diterima
                                {% elif form.status == 'rejected' %}
                                    Ditolak
                                {% endif %}
                                
                                {% if form.payment_status and form.status == 'accepted' %}
                                    <br>
                                    <strong>Status Pembayaran:</strong><br>
                                    {% if form.payment_status == 'unsubmitted' %}
                                        Belum Dibayar
                                    {% elif form.payment_status == 'submitted' %}
                                        Menunggu Verifikasi
                                    {% elif form.payment_status == 'verified' %}
                                        Terverifikasi
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-file-earmark-text text-muted display-4"></i>
                        <p class="mt-3">Belum ada pendaftaran yang diajukan.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Payment Information Section -->
        

            <!-- Payment Amount Section -->
          

            <!-- Bank Transfer Details -->
            


            <!-- QR Code Section -->



            <!-- Payment History -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- Registration Status and Payment Card -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-clipboard2-check text-primary me-2"></i>Status Pendaftaran
        </h5>
    </div>
    <div class="card-body">
        {% if form %}
            <!-- Progress Tracker -->
            <div class="progress-tracker mb-4">
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated 
                              {{ 'bg-success' if form.status == 'accepted' }}
                              {{ 'bg-danger' if form.status == 'rejected' }}
                              {{ 'bg-info' if form.status == 'pending' }}" 
                         role="progressbar" 
                         style="width: {{ form.progress_percentage }}%"
                         aria-valuenow="{{ form.progress_percentage }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">Progress Kelengkapan</small>
                    <small class="text-muted">{{ form.progress_percentage }}%</small>
                </div>
            </div>

            <!-- Status Timeline -->
            <div class="status-timeline mb-4">
                <!-- Registration Submitted -->
                <div class="timeline-item {{ 'completed' if form }}">
                    <div class="timeline-icon">
                        <i class="bi bi-send-check-fill"></i>
                    </div>
                    <div class="timeline-content">
                        <h6 class="mb-1">Pendaftaran Terkirim</h6>
                        <p class="small text-muted mb-0">{{ form.timestamp.strftime('%d-%m-%Y %H:%M') }}</p>
                    </div>
                </div>

                <!-- Document Verification -->
                <div class="timeline-item {{ 'completed' if form.status in ['accepted', 'rejected'] }} 
                                        {{ 'active' if form.status == 'pending' }}
                                        {{ 'rejected' if form.status == 'rejected' }}">
                    <div class="timeline-icon">
                        <i class="bi {{ 'bi-check-circle-fill' if form.status == 'accepted' 
                                     else 'bi-x-circle-fill' if form.status == 'rejected'
                                     else 'bi-hourglass-split' }}"></i>
                    </div>
                    <div class="timeline-content">
                        <h6 class="mb-1">Verifikasi Berkas</h6>
                        <p class="small text-muted mb-0">
                            {% if form.status == 'pending' %}
                                Sedang diverifikasi
                            {% elif form.status == 'accepted' %}
                                Berkas diterima
                            {% elif form.status == 'rejected' %}
                                Berkas ditolak
                            {% endif %}
                        </p>
                    </div>
                </div>

                <!-- Payment Status -->
                {% if form.status == 'accepted' %}
                <div class="timeline-item {{ 'completed' if form.payment_status == 'verified' }}
                                        {{ 'active' if form.payment_status == 'submitted' }}">
                    <div class="timeline-icon">
                        <i class="bi {{ 'bi-check-circle-fill' if form.payment_status == 'verified'
                                     else 'bi-credit-card' if form.payment_status == 'submitted'
                                     else 'bi-wallet' }}"></i>
                    </div>
                    <div class="timeline-content">
                        <h6 class="mb-1">Pembayaran</h6>
                        <p class="small text-muted mb-0">
                            {% if form.payment_status == 'unsubmitted' %}
                                Menunggu pembayaran
                            {% elif form.payment_status == 'submitted' %}
                                Menunggu verifikasi
                            {% elif form.payment_status == 'verified' %}
                                Pembayaran terverifikasi
                            {% endif %}
                        </p>
                    </div>
                </div>

                <!-- Registration Complete -->
                {% if form.payment_status == 'verified' %}
                <div class="timeline-item completed">
                    <div class="timeline-icon">
                        <i class="bi bi-check-circle-fill text-success"></i>
                    </div>
                    <div class="timeline-content">
                        <h6 class="mb-1">Pendaftaran Selesai</h6>
                        <p class="small text-muted mb-0">Selamat! Anda telah diterima</p>
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>

            <!-- Current Status Alert -->
            <div class="alert alert-{{ 'success' if form.status == 'accepted' 
                                    else 'danger' if form.status == 'rejected' 
                                    else 'info' }} mb-4">
                <div class="d-flex align-items-center">
                    <i class="bi {{ 'bi-check-circle-fill' if form.status == 'accepted' 
                                 else 'bi-x-circle-fill' if form.status == 'rejected'
                                 else 'bi-info-circle-fill' }} me-2"></i>
                    <div>
                        <strong>Status Saat Ini:</strong><br>
                        {% if form.status == 'pending' %}
                            Menunggu Verifikasi
                        {% elif form.status == 'accepted' %}
                            Diterima
                        {% elif form.status == 'rejected' %}
                            Ditolak
                        {% endif %}
                        
                        {% if form.payment_status and form.status == 'accepted' %}
                            <br>
                            <strong>Status Pembayaran:</strong><br>
                            {% if form.payment_status == 'unsubmitted' %}
                                Belum Dibayar
                            {% elif form.payment_status == 'submitted' %}
                                Menunggu Verifikasi
                            {% elif form.payment_status == 'verified' %}
                                Terverifikasi
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if form.status == 'accepted' and form.payment_status != 'verified' %}
            <!-- Payment Section -->
            <div class="payment-section">
                <h6 class="mb-3">Informasi Pembayaran</h6>
                
                <!-- Payment Amount Card -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <div class="payment-details">
                            <div class="payment-item d-flex justify-content-between mb-2">
                                <span class="text-muted">Biaya Pendaftaran</span>
                                <span>Rp7.000.000</span>
                            </div>
                            <div class="payment-item d-flex justify-content-between mb-2">
                                <span class="text-muted">SPP (1 Bulan)</span>
                                <span>Rp500.000</span>
                            </div>
                            <hr>
                            <div class="payment-total d-flex justify-content-between">
                                <strong>Total Pembayaran</strong>
                                <strong class="text-primary">Rp7.500.000</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method Cards -->
                <div class="row g-3 mb-4">
                    <!-- Bank Transfer -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-bank me-2"></i>Transfer Bank
                                </h6>
                                <div class="bank-details mt-3">
                                    <div class="bank-item mb-2">
                                        <small class="text-muted d-block">Bank</small>
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">Bank Mandiri</span>
                                            <button class="btn btn-sm btn-link p-0 copy-button" 
                                                    data-clipboard-text="Bank Mandiri">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="bank-item mb-2">
                                        <small class="text-muted d-block">Nomor Rekening</small>
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">1234567890</span>
                                            <button class="btn btn-sm btn-link p-0 copy-button" 
                                                    data-clipboard-text="1234567890">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="bank-item">
                                        <small class="text-muted d-block">Atas Nama</small>
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">SMKN 1 BEKASI</span>
                                            <button class="btn btn-sm btn-link p-0 copy-button" 
                                                    data-clipboard-text="SMKN 1 BEKASI">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- QRIS -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h6 class="card-title">
                                    <i class="bi bi-qr-code me-2"></i>QRIS
                                </h6>
                                <div class="qr-section mt-3">
                                    <img src="{{ url_for('static', filename='img/qr-code.png') }}" 
                                         alt="QRIS Payment" class="img-fluid mb-2" 
                                         style="max-width: 150px;">
                                    <p class="small text-muted mb-0">
                                        Scan untuk pembayaran instan via QRIS<br>
                                        (OVO, GoPay, DANA, dll)
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if form.payment_status == 'unsubmitted' %}
                <!-- Payment Upload Form -->
                <div class="upload-payment-proof">
                    <form method="POST" action="{{ url_for('main.submit_payment') }}" 
                          enctype="multipart/form-data" class="card">
                        <div class="card-body">
                            {{ payment_form.hidden_tag() }}
                            <div class="mb-3">
                                <label class="form-label">Upload Bukti Pembayaran</label>
                                {{ payment_form.payment_proof(class="form-control") }}
                                <small class="text-muted">Format yang didukung: JPG, PNG, PDF</small>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-cloud-upload me-2"></i>Kirim Bukti Pembayaran
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
            {% endif %}
        {% else %}
            <div class="text-center py-4">
                <i class="bi bi-file-earmark-text text-muted display-4"></i>
                <p class="mt-3">Belum ada pendaftaran yang diajukan.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal{{ form.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pas Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <img src="data:{{ form.photo_mimetype }};base64,{{ form.photo_data|b64encode }}"
                     class="img-fluid w-100"
                     alt="Pas Foto">
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('main.download_file', form_id=form.id, document_type='photo') }}" 
                   class="btn btn-primary">
                    <i class="bi bi-download"></i> Unduh
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize clipboard.js
    new ClipboardJS('.copy-button').on('success', function(e) {
        const button = e.trigger;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 1000);
    });

    // Document viewer functionality
    document.querySelectorAll('.view-doc-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const docType = this.dataset.docType;
            const formId = document.getElementById('formId').value;
            const modalId = `fileModal${formId}_${docType}`;
            const modal = document.getElementById(modalId);
            
            if (modal) {
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();
            }
        });
    });
});
</script>
{% endblock %}